<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Visitor Checkin</title>

    <script src="../js/jquery-2.1.3.js" type="text/javascript"></script>
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>
 
     <link href="../css/bootstrap.min.css" rel="stylesheet">
     <link href="../css/bootstrap-overrides.css" rel="stylesheet">
     <link href="../css/admin-overrides.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="http://library.clevelandart.org">
            <img alt="Ingalls Library home page" src="../images/cma-logo.png">
          </a>
       </div>
       <!-- Since there are only three links run them across the top -->
       <ul class="nav navbar-nav">
         <li class="active"><a href="home.html">Home</a></li>
         <li class="dropdown">
           <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Registrations <span class="caret"></span></a>
           <ul class="dropdown-menu">
             <li><a href="registrations-archived.html">Archived</a></li>
             <li><a href="registrations-pending.html">Pending</a></li>
             <li><a href="registrations-all.html">View all</a></li>
           </ul>
         </li>
       </ul>
    </div>
  </nav>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1>Registrations</h1>
        <form class="form-inline" id="user-filters">
          <div class="form-group">
            <label for="status">Status</label>
            <select class="form-control" data-filterfor="status">
                <option value="">All</option>
                <option>Completed</option>
                <option>Pending</option>
            </select>
          </div>

          <div class="form-group">
            <label for="role">Role</label>
            <select class="form-control" data-filterfor="role">
              <option value="">All</option>
              <option>Academic</option>
              <option>Docent</option>
              <option>Fellow</option>
              <option>Intern</option>
              <option>Member</option>
              <option>Public</option>
              <option>Staff</option>
              <option>Volunteer</option>             
            </select>
          </div>

          <div class="form-group pull-right">
            <label for="text_filter">Filter by</label>
            <input type="text" class="form-control" name="text_filter" data-filterfor="name"></input> 
          </div>
        </form>
  
        <table class="table table-striped" id="registered_users">
          <thead>
            <th class="col-md-3">Name <span class="caret"></span></th>
            <th class="col-md-2">Role <span class="caret"></span></th>
            <th class="col-md-3">Registered on</th>
            <th class="col-md-2">ID confirmed</th>
            <th class="col-md-2">Linked to Aleph</th>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <script type="text/javascript">
    $(document).ready(function() {
       registerFormListeners("#user-filters");
       loadRegistrants();
    });

    /**
     * Since there are so few users just load them all even if you only
     * want to view a subset
     */
    var users = null;
    var visible_users = users;

    function loadRegistrants() {
      $.ajax({
        url: "../js/registrants.json",
        success: function(json) { saveAndRenderRegistrants(json) },
        error: function(xhr, status, errorThrown) {
          console.log("Error : " + errorThrown);
          console.log("Status : " + status);
          console.dir(xhr);
        }
      });
    }

    function saveAndRenderRegistrants(source) {
      saveRegistrants(source);
      renderRegistrants(); 
    }

    function saveRegistrants(source) {
      users = source;
    }

    function renderRegistrants() {
      destination = $("table#registered_users tbody");
      destination.html(null);
      applyFilters();
      $.each(visible_users, function(index, value) {
        html = $('#registrant_template').html();
        html = html.replace("{{name}}", value.name);
        html = html.replace("{{role}}", value.role);
        html = html.replace("{{registration_date}}", value.registered);

        html = html.replace("{{confirmed}}", getStatusIcon(value.confirmed));
        html = html.replace("{{in_aleph}}", getStatusIcon(value.linked_to_aleph));

        destination.append(html); 
      });
    }

    function applyFilters() {
      visible_users = users;
      applyStatusFilter();
      applyRoleFilter();
      applyNameFilter(); 
    }

    function applyStatusFilter() {
      dropdown_state = $("#user-filters *[data-filterfor=status]")[0];
      switch (dropdown_state.value) {
        case "Completed":
          visible_users = visible_users.filter(function(u) { return (u.confirmed && u.linked_to_aleph) });
          break;
        case "Pending":
          visible_users = visible_users.filter(function(u) {
            /* Simulate an NAND operation */
            console.log("Confirmed : " + u.confirmed);
            console.log("Linked to Aleph : " + u.linked_in_aleph);
            console.log("NAND Result : " + !(u.confirmed && u.linked_to_aleph));
            return !(u.confirmed && u.linked_to_aleph); 
          });
          break;
        default:
          /* No OP */
      }
     
      return visible_users; 
    }

    function applyRoleFilter() {
      dropdown_state = $("#user-filters *[data-filterfor=role]")[0];
      if ("" != dropdown_state.value) {
        visible_users = visible_users.filter(function(u) { return u.role == dropdown_state.value });
      } else {
        /* No OP */
      }

      return visible_users;
    }

    function applyNameFilter() {
      filter = $("#user-filters *[data-filterfor=name]")[0];
      filter = filter.value;

      if ("" != filter) {
        visible_users = visible_users.filter(function(u) { return (u.name.indexOf(filter) >= 0); });
      }

      return visible_users;      
    }

    function getStatusIcon(flag) {
      if (flag) {
        return "<span class=\"glyphicon glyphicon-ok\"></span>"
      } else {
        return "<span>&nbsp;</span>"
      }
    }

    function registerFormListeners(element) {
      form = $(element);
      form.find("select").change(function() {
        applyFilters();
        renderRegistrants();
      });
      form.find("input[type='text']").keyup(function() {
        applyFilters();
        renderRegistrants();
      });
    }
  </script>

  <script id="registrant_template" type="text/template">
    <tr>
      <td data-field="name">{{name}}</td>
      <td data-field="role">{{role}}</td>
      <td data-field="registration_date">{{registration_date}}</td>
      <td data-field="confirmed">{{confirmed}}</td>
      <td data-field="in_aleph">{{in_aleph}}</td>
    </tr>
  </script>
</body>
</html>
